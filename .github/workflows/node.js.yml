# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs
# test
name: Build step

on:
  push:
    branches: 
     - main
     - dev
     - stagging
     - prod
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js 
      uses: actions/setup-node@v3
      with:
        node-version: '16.x'
    - run: npm ci
    








 
  build-and-push-docker-image:
     
     name: login to DockerHub and push image to repository
     runs-on: ubuntu-latest
     needs: ['build']
     steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Get the latest tag
        id: latest_tag
        run: echo "::set-output name=TAG::$(git describe --abbrev=0 --tags)"
      - name: Determine next version
        id: next_version
        run: |
          current_tag="${{ steps.latest_tag.outputs.TAG }}"
          IFS='.' read -r -a version_parts <<< "${current_tag#v}"
          next_patch=$((version_parts[1] + 1))
          next_version="v${version_parts[0]}.${version_parts[1]}.$next_patch"
          echo "::set-output name=VERSION::$next_version"

     

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build image and push to Docker Hub 
        uses: docker/build-push-action@v2
        if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/stagging'  
        with:
          context: ./
          tags: |
            houwayda/test:${{ github.sha }}
          push: true
      - name: Push to another repository (prod)
        uses: docker/build-push-action@v2
        if: github.ref == 'refs/heads/prod' && github.event_name == 'push'
        with:
          context: ./
          tags: |
            houwayda/prod:${{ steps.next_version.outputs.VERSION }}
          push: true

 
          
        
  update-kustomize-overlay:
    runs-on: ubuntu-latest
    needs: ['build-and-push-docker-image']

    steps:
      - name: Checkout another repository
        uses: actions/checkout@v2
        with:
          repository: houwayda9/kustomize
          ref: main
          token: ${{ secrets.G_TOKEN3 }}
          path: houwayda9/kustomize 

      - name: Update Kustomize Overlay
        run: |
          case "${{ github.ref }}" in
            "refs/heads/dev")
              overlay_dir="dev"
              ;;
            "refs/heads/prod")
              overlay_dir="prod"
              ;;
            "refs/heads/satgging")
              overlay_dir="satgging"
              ;;
            *)
              echo "Unexpected branch: ${{ github.ref }}"
              exit 1
              ;;
          esac
          
          cd houwayda9/kustomize/kustomize/overlays/${overlay_dir}
          sed -i "s|newTag: .*|newTag: ${{ github.sha }}|" kustomization.yaml 
          git config --global user.email ${{ secrets.USER_EMAIL }}
          git config --global user.name ${{ secrets.USER_NAME }}
          git add kustomization.yaml
          git commit -m "Update image for - ${{ github.sha }}"
          git push origin main
  
            
   
  

  



  

      
      
          
           
          
    
